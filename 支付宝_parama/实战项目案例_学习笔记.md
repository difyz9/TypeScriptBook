# 支付宝小程序开发实战项目案例 - 学习笔记

## 项目一：智能便民服务小程序

### 项目概述
开发一个集成多种便民服务的智能小程序，包括生活缴费、充值服务、预约挂号、政务办事等功能。

### 功能模块设计

#### 1. 首页布局设计
```xml
<!-- pages/index/index.axml -->
<view class="page">
  <!-- 顶部轮播图 -->
  <swiper class="banner-swiper" autoplay="{{true}}" interval="{{3000}}" circular="{{true}}">
    <swiper-item a:for="{{bannerList}}" a:key="id">
      <image class="banner-image" src="{{item.imageUrl}}" onTap="onBannerTap" data-item="{{item}}" />
    </swiper-item>
  </swiper>
  
  <!-- 快捷服务网格 -->
  <view class="service-grid">
    <view class="grid-title">
      <text>便民服务</text>
    </view>
    <view class="grid-container">
      <view class="grid-item" a:for="{{serviceList}}" a:key="id" onTap="onServiceTap" data-service="{{item}}">
        <image class="service-icon" src="{{item.iconUrl}}" />
        <text class="service-name">{{item.name}}</text>
      </view>
    </view>
  </view>
  
  <!-- 热门服务 -->
  <view class="hot-services">
    <view class="section-title">
      <text>热门服务</text>
      <text class="more-btn" onTap="onViewMore">更多 ></text>
    </view>
    <view class="hot-list">
      <view class="hot-item" a:for="{{hotServices}}" a:key="id" onTap="onHotServiceTap" data-service="{{item}}">
        <image class="hot-icon" src="{{item.iconUrl}}" />
        <view class="hot-info">
          <text class="hot-title">{{item.title}}</text>
          <text class="hot-desc">{{item.description}}</text>
        </view>
        <view class="hot-tag">
          <text>热门</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 最近使用 -->
  <view class="recent-services" a:if="{{recentList.length > 0}}">
    <view class="section-title">
      <text>最近使用</text>
    </view>
    <scroll-view class="recent-scroll" scroll-x="{{true}}">
      <view class="recent-item" a:for="{{recentList}}" a:key="id" onTap="onRecentTap" data-service="{{item}}">
        <image class="recent-icon" src="{{item.iconUrl}}" />
        <text class="recent-name">{{item.name}}</text>
      </view>
    </scroll-view>
  </view>
</view>
```

#### 2. 首页样式设计
```css
/* pages/index/index.acss */
.page {
  background-color: #f5f5f5;
  min-height: 100vh;
}

.banner-swiper {
  width: 100%;
  height: 300rpx;
  margin-bottom: 20rpx;
}

.banner-image {
  width: 100%;
  height: 100%;
  border-radius: 0 0 20rpx 20rpx;
}

.service-grid {
  background: white;
  margin: 0 20rpx 20rpx;
  border-radius: 12rpx;
  padding: 30rpx;
}

.grid-title {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 30rpx;
}

.grid-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
}

.grid-item {
  width: 22%;
  text-align: center;
  margin-bottom: 30rpx;
}

.service-icon {
  width: 60rpx;
  height: 60rpx;
  margin-bottom: 10rpx;
}

.service-name {
  font-size: 24rpx;
  color: #666;
  display: block;
}

.hot-services, .recent-services {
  background: white;
  margin: 0 20rpx 20rpx;
  border-radius: 12rpx;
  padding: 30rpx;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
}

.section-title text:first-child {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
}

.more-btn {
  font-size: 28rpx;
  color: #1677FF;
}

.hot-item {
  display: flex;
  align-items: center;
  padding: 20rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
  position: relative;
}

.hot-item:last-child {
  border-bottom: none;
}

.hot-icon {
  width: 80rpx;
  height: 80rpx;
  margin-right: 20rpx;
  border-radius: 8rpx;
}

.hot-info {
  flex: 1;
}

.hot-title {
  font-size: 32rpx;
  color: #333;
  display: block;
  margin-bottom: 10rpx;
}

.hot-desc {
  font-size: 24rpx;
  color: #999;
  display: block;
}

.hot-tag {
  background: linear-gradient(45deg, #FF6B6B, #FF8E53);
  color: white;
  font-size: 20rpx;
  padding: 6rpx 12rpx;
  border-radius: 20rpx;
}

.recent-scroll {
  white-space: nowrap;
}

.recent-item {
  display: inline-block;
  text-align: center;
  margin-right: 30rpx;
  vertical-align: top;
}

.recent-icon {
  width: 60rpx;
  height: 60rpx;
  margin-bottom: 10rpx;
  display: block;
}

.recent-name {
  font-size: 24rpx;
  color: #666;
  display: block;
  width: 80rpx;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

#### 3. 首页逻辑实现
```javascript
// pages/index/index.js
Page({
  data: {
    bannerList: [],
    serviceList: [],
    hotServices: [],
    recentList: [],
    loading: false
  },

  onLoad() {
    this.initPageData();
  },

  onShow() {
    this.loadRecentServices();
  },

  async initPageData() {
    this.setData({ loading: true });
    
    try {
      await Promise.all([
        this.loadBannerData(),
        this.loadServiceData(),
        this.loadHotServices()
      ]);
    } catch (error) {
      console.error('页面数据加载失败:', error);
      my.showToast({
        type: 'fail',
        content: '页面加载失败，请稍后重试'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  async loadBannerData() {
    try {
      const res = await my.request({
        url: 'https://api.example.com/banners',
        method: 'GET',
        data: { position: 'home_banner' }
      });
      
      this.setData({
        bannerList: res.data.list || []
      });
    } catch (error) {
      console.error('轮播图加载失败:', error);
    }
  },

  async loadServiceData() {
    const defaultServices = [
      { id: 1, name: '生活缴费', iconUrl: '/images/icons/bill.png', type: 'bill' },
      { id: 2, name: '手机充值', iconUrl: '/images/icons/recharge.png', type: 'recharge' },
      { id: 3, name: '预约挂号', iconUrl: '/images/icons/hospital.png', type: 'hospital' },
      { id: 4, name: '政务办事', iconUrl: '/images/icons/government.png', type: 'government' },
      { id: 5, name: '公交查询', iconUrl: '/images/icons/bus.png', type: 'transport' },
      { id: 6, name: '天气预报', iconUrl: '/images/icons/weather.png', type: 'weather' },
      { id: 7, name: '快递查询', iconUrl: '/images/icons/express.png', type: 'express' },
      { id: 8, name: '更多服务', iconUrl: '/images/icons/more.png', type: 'more' }
    ];

    this.setData({
      serviceList: defaultServices
    });
  },

  async loadHotServices() {
    try {
      const res = await my.request({
        url: 'https://api.example.com/hot-services',
        method: 'GET'
      });
      
      this.setData({
        hotServices: res.data.list || []
      });
    } catch (error) {
      console.error('热门服务加载失败:', error);
    }
  },

  loadRecentServices() {
    try {
      const recentData = my.getStorageSync({
        key: 'recent_services'
      });
      
      if (recentData.success && recentData.data) {
        this.setData({
          recentList: recentData.data.slice(0, 8) // 最多显示8个
        });
      }
    } catch (error) {
      console.error('最近使用加载失败:', error);
    }
  },

  onBannerTap(e) {
    const item = e.currentTarget.dataset.item;
    if (item.linkUrl) {
      my.navigateTo({
        url: item.linkUrl
      });
    }
  },

  onServiceTap(e) {
    const service = e.currentTarget.dataset.service;
    this.addToRecentServices(service);
    this.navigateToService(service);
  },

  onHotServiceTap(e) {
    const service = e.currentTarget.dataset.service;
    this.addToRecentServices(service);
    this.navigateToService(service);
  },

  onRecentTap(e) {
    const service = e.currentTarget.dataset.service;
    this.navigateToService(service);
  },

  navigateToService(service) {
    const routeMap = {
      'bill': '/pages/bill/bill',
      'recharge': '/pages/recharge/recharge',
      'hospital': '/pages/hospital/hospital',
      'government': '/pages/government/government',
      'transport': '/pages/transport/transport',
      'weather': '/pages/weather/weather',
      'express': '/pages/express/express',
      'more': '/pages/services/services'
    };

    const url = routeMap[service.type];
    if (url) {
      my.navigateTo({ url });
    } else {
      my.showToast({
        type: 'none',
        content: '功能开发中...'
      });
    }
  },

  addToRecentServices(service) {
    try {
      let recentList = this.data.recentList || [];
      
      // 移除已存在的同类型服务
      recentList = recentList.filter(item => item.id !== service.id);
      
      // 添加到开头
      recentList.unshift(service);
      
      // 限制数量
      if (recentList.length > 10) {
        recentList = recentList.slice(0, 10);
      }
      
      // 保存到本地存储
      my.setStorageSync({
        key: 'recent_services',
        data: recentList
      });
      
      // 更新页面数据
      this.setData({
        recentList: recentList.slice(0, 8)
      });
    } catch (error) {
      console.error('保存最近使用失败:', error);
    }
  },

  onViewMore() {
    my.navigateTo({
      url: '/pages/services/services'
    });
  },

  onPullDownRefresh() {
    this.initPageData().finally(() => {
      my.stopPullDownRefresh();
    });
  }
});
```

### 生活缴费功能实现

#### 1. 缴费页面结构
```xml
<!-- pages/bill/bill.axml -->
<view class="page">
  <!-- 缴费类型选择 -->
  <view class="bill-types">
    <view class="type-item {{currentType === item.type ? 'active' : ''}}" 
          a:for="{{billTypes}}" 
          a:key="type"
          onTap="onTypeChange"
          data-type="{{item.type}}">
      <image class="type-icon" src="{{item.iconUrl}}" />
      <text class="type-name">{{item.name}}</text>
    </view>
  </view>
  
  <!-- 缴费表单 -->
  <view class="bill-form">
    <view class="form-section">
      <view class="section-title">缴费信息</view>
      
      <!-- 动态表单字段 -->
      <view class="form-item" a:for="{{formFields}}" a:key="field">
        <text class="label">{{item.label}}</text>
        <input 
          class="input-field"
          placeholder="{{item.placeholder}}"
          value="{{formData[item.field]}}"
          type="{{item.type}}"
          maxlength="{{item.maxlength}}"
          onInput="onFieldInput"
          data-field="{{item.field}}" />
      </view>
      
      <!-- 查询按钮 -->
      <button class="query-btn" onTap="onQueryBill" loading="{{querying}}">
        {{querying ? '查询中...' : '查询账单'}}
      </button>
    </view>
    
    <!-- 账单信息 -->
    <view class="bill-info" a:if="{{billData}}">
      <view class="section-title">账单详情</view>
      <view class="info-item">
        <text class="info-label">户号</text>
        <text class="info-value">{{billData.accountNumber}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">户名</text>
        <text class="info-value">{{billData.accountName}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">欠费金额</text>
        <text class="info-value amount">¥{{billData.amount}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">账单周期</text>
        <text class="info-value">{{billData.billPeriod}}</text>
      </view>
      
      <!-- 支付按钮 -->
      <button class="pay-btn" onTap="onPayBill" loading="{{paying}}">
        {{paying ? '支付中...' : `立即缴费 ¥${billData.amount}`}}
      </button>
    </view>
  </view>
  
  <!-- 历史记录 -->
  <view class="history-section">
    <view class="section-title">
      <text>缴费记录</text>
      <text class="view-all" onTap="onViewAllHistory">查看全部</text>
    </view>
    <view class="history-list">
      <view class="history-item" a:for="{{historyList}}" a:key="id">
        <view class="history-info">
          <text class="history-type">{{item.typeName}}</text>
          <text class="history-account">{{item.accountNumber}}</text>
          <text class="history-time">{{item.payTime}}</text>
        </view>
        <view class="history-amount">
          <text>¥{{item.amount}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
```

#### 2. 缴费功能逻辑
```javascript
// pages/bill/bill.js
Page({
  data: {
    currentType: 'electric',
    billTypes: [
      { type: 'electric', name: '电费', iconUrl: '/images/icons/electric.png' },
      { type: 'water', name: '水费', iconUrl: '/images/icons/water.png' },
      { type: 'gas', name: '燃气费', iconUrl: '/images/icons/gas.png' },
      { type: 'property', name: '物业费', iconUrl: '/images/icons/property.png' }
    ],
    formFields: [],
    formData: {},
    billData: null,
    historyList: [],
    querying: false,
    paying: false
  },

  onLoad() {
    this.initFormFields();
    this.loadHistory();
  },

  initFormFields() {
    const fieldConfigs = {
      electric: [
        { field: 'accountNumber', label: '户号', placeholder: '请输入用电户号', type: 'text', maxlength: 20 },
        { field: 'address', label: '用电地址', placeholder: '请输入用电地址', type: 'text', maxlength: 50 }
      ],
      water: [
        { field: 'accountNumber', label: '户号', placeholder: '请输入用水户号', type: 'text', maxlength: 20 }
      ],
      gas: [
        { field: 'accountNumber', label: '户号', placeholder: '请输入燃气户号', type: 'text', maxlength: 20 }
      ],
      property: [
        { field: 'accountNumber', label: '房屋编号', placeholder: '请输入房屋编号', type: 'text', maxlength: 20 },
        { field: 'ownerName', label: '业主姓名', placeholder: '请输入业主姓名', type: 'text', maxlength: 10 }
      ]
    };

    this.setData({
      formFields: fieldConfigs[this.data.currentType] || [],
      formData: {},
      billData: null
    });
  },

  onTypeChange(e) {
    const type = e.currentTarget.dataset.type;
    this.setData({ currentType: type });
    this.initFormFields();
  },

  onFieldInput(e) {
    const { field } = e.currentTarget.dataset;
    const { value } = e.detail;
    
    this.setData({
      [`formData.${field}`]: value
    });
  },

  async onQueryBill() {
    // 验证表单
    const validation = this.validateForm();
    if (!validation.isValid) {
      my.showToast({
        type: 'fail',
        content: validation.message
      });
      return;
    }

    this.setData({ querying: true });

    try {
      const res = await my.request({
        url: 'https://api.example.com/bills/query',
        method: 'POST',
        data: {
          type: this.data.currentType,
          ...this.data.formData
        }
      });

      if (res.data.code === 0) {
        this.setData({
          billData: res.data.data
        });
      } else {
        my.showToast({
          type: 'fail',
          content: res.data.message || '查询失败'
        });
      }
    } catch (error) {
      console.error('查询账单失败:', error);
      my.showToast({
        type: 'fail',
        content: '查询失败，请稍后重试'
      });
    } finally {
      this.setData({ querying: false });
    }
  },

  validateForm() {
    const { formFields, formData } = this.data;
    
    for (const field of formFields) {
      if (!formData[field.field] || formData[field.field].trim() === '') {
        return {
          isValid: false,
          message: `请输入${field.label}`
        };
      }
    }
    
    return { isValid: true };
  },

  async onPayBill() {
    if (!this.data.billData) {
      my.showToast({
        type: 'fail',
        content: '请先查询账单'
      });
      return;
    }

    this.setData({ paying: true });

    try {
      // 调用支付宝支付
      const orderInfo = await this.createPayOrder();
      
      my.tradePay({
        orderStr: orderInfo.orderString,
        success: (res) => {
          console.log('支付成功:', res);
          this.handlePaySuccess();
        },
        fail: (err) => {
          console.error('支付失败:', err);
          my.showToast({
            type: 'fail',
            content: '支付失败'
          });
        }
      });
    } catch (error) {
      console.error('创建订单失败:', error);
      my.showToast({
        type: 'fail',
        content: '支付失败，请稍后重试'
      });
    } finally {
      this.setData({ paying: false });
    }
  },

  async createPayOrder() {
    const res = await my.request({
      url: 'https://api.example.com/bills/pay/create-order',
      method: 'POST',
      data: {
        billId: this.data.billData.id,
        amount: this.data.billData.amount,
        type: this.data.currentType,
        accountNumber: this.data.formData.accountNumber
      }
    });

    if (res.data.code === 0) {
      return res.data.data;
    } else {
      throw new Error(res.data.message || '创建订单失败');
    }
  },

  handlePaySuccess() {
    my.showToast({
      type: 'success',
      content: '缴费成功'
    });

    // 重新加载历史记录
    this.loadHistory();
    
    // 清空账单信息
    this.setData({
      billData: null,
      formData: {}
    });

    // 2秒后返回首页
    setTimeout(() => {
      my.navigateBack();
    }, 2000);
  },

  async loadHistory() {
    try {
      const res = await my.request({
        url: 'https://api.example.com/bills/history',
        method: 'GET',
        data: { limit: 5 }
      });

      if (res.data.code === 0) {
        this.setData({
          historyList: res.data.data.list || []
        });
      }
    } catch (error) {
      console.error('加载历史记录失败:', error);
    }
  },

  onViewAllHistory() {
    my.navigateTo({
      url: '/pages/bill-history/bill-history'
    });
  }
});
```

### 支付集成实现

#### 1. 支付工具类
```javascript
// utils/payment.js
class PaymentManager {
  /**
   * 创建支付订单
   * @param {Object} orderData 订单数据
   * @returns {Promise} 订单信息
   */
  static async createOrder(orderData) {
    try {
      const res = await my.request({
        url: 'https://api.example.com/payment/create-order',
        method: 'POST',
        data: {
          subject: orderData.subject,        // 商品标题
          body: orderData.body,              // 商品描述
          totalAmount: orderData.amount,     // 订单金额
          outTradeNo: orderData.orderNo,     // 商户订单号
          productCode: 'QUICK_MSECURITY_PAY', // 产品码
          timeoutExpress: '30m',             // 超时时间
          businessParams: orderData.businessParams || {},
          extendParams: orderData.extendParams || {}
        }
      });

      if (res.data.code === 0) {
        return res.data.data;
      } else {
        throw new Error(res.data.message || '创建订单失败');
      }
    } catch (error) {
      console.error('创建支付订单失败:', error);
      throw error;
    }
  }

  /**
   * 调用支付宝支付
   * @param {string} orderString 订单字符串
   * @returns {Promise} 支付结果
   */
  static async pay(orderString) {
    return new Promise((resolve, reject) => {
      my.tradePay({
        orderStr: orderString,
        success: (res) => {
          console.log('支付成功:', res);
          resolve(res);
        },
        fail: (err) => {
          console.error('支付失败:', err);
          reject(err);
        }
      });
    });
  }

  /**
   * 查询支付结果
   * @param {string} outTradeNo 商户订单号
   * @returns {Promise} 支付状态
   */
  static async queryPaymentResult(outTradeNo) {
    try {
      const res = await my.request({
        url: 'https://api.example.com/payment/query',
        method: 'GET',
        data: { outTradeNo }
      });

      if (res.data.code === 0) {
        return res.data.data;
      } else {
        throw new Error(res.data.message || '查询失败');
      }
    } catch (error) {
      console.error('查询支付结果失败:', error);
      throw error;
    }
  }

  /**
   * 处理支付流程
   * @param {Object} orderData 订单数据
   * @param {Function} onSuccess 成功回调
   * @param {Function} onFail 失败回调
   */
  static async processPayment(orderData, onSuccess, onFail) {
    try {
      // 1. 创建订单
      const orderInfo = await this.createOrder(orderData);
      
      // 2. 调用支付
      const payResult = await this.pay(orderInfo.orderString);
      
      // 3. 验证支付结果
      if (payResult.resultCode === '9000') {
        // 支付成功
        if (onSuccess) {
          onSuccess(payResult);
        }
      } else if (payResult.resultCode === '8000') {
        // 支付结果确认中
        const queryResult = await this.queryPaymentResult(orderData.orderNo);
        if (queryResult.tradeStatus === 'TRADE_SUCCESS') {
          if (onSuccess) {
            onSuccess(payResult);
          }
        } else {
          if (onFail) {
            onFail(new Error('支付状态确认失败'));
          }
        }
      } else {
        // 支付失败
        if (onFail) {
          onFail(new Error('支付失败'));
        }
      }
    } catch (error) {
      if (onFail) {
        onFail(error);
      }
    }
  }
}

export default PaymentManager;
```

### 用户体验优化

#### 1. 加载状态管理
```javascript
// utils/loading.js
class LoadingManager {
  constructor() {
    this.loadingCount = 0;
    this.loadingTimer = null;
  }

  show(title = '加载中...', mask = true) {
    this.loadingCount++;
    
    if (this.loadingCount === 1) {
      my.showLoading({
        content: title,
        mask: mask
      });
    }
  }

  hide() {
    this.loadingCount = Math.max(0, this.loadingCount - 1);
    
    if (this.loadingCount === 0) {
      my.hideLoading();
    }
  }

  showWithTimeout(title = '加载中...', timeout = 10000) {
    this.show(title);
    
    this.loadingTimer = setTimeout(() => {
      this.hide();
      my.showToast({
        type: 'fail',
        content: '请求超时，请稍后重试'
      });
    }, timeout);
  }

  hideWithClearTimeout() {
    this.hide();
    if (this.loadingTimer) {
      clearTimeout(this.loadingTimer);
      this.loadingTimer = null;
    }
  }
}

const loadingManager = new LoadingManager();
export default loadingManager;
```

#### 2. 错误边界处理
```javascript
// utils/error-boundary.js
class ErrorBoundary {
  static handleError(error, context = '') {
    console.error(`[${context}] 错误:`, error);
    
    // 记录错误日志
    this.logError(error, context);
    
    // 显示用户友好的错误信息
    this.showUserFriendlyError(error);
  }

  static logError(error, context) {
    const errorInfo = {
      message: error.message,
      stack: error.stack,
      context: context,
      timestamp: new Date().toISOString(),
      userAgent: my.getSystemInfoSync().platform,
      appVersion: my.getSystemInfoSync().version
    };

    // 发送错误日志到服务器
    my.request({
      url: 'https://api.example.com/logs/error',
      method: 'POST',
      data: errorInfo,
      fail: (err) => {
        console.error('发送错误日志失败:', err);
      }
    });
  }

  static showUserFriendlyError(error) {
    let message = '操作失败，请稍后重试';
    
    if (error.message) {
      if (error.message.includes('网络')) {
        message = '网络连接失败，请检查网络设置';
      } else if (error.message.includes('超时')) {
        message = '请求超时，请稍后重试';
      } else if (error.message.includes('unauthorized')) {
        message = '请先登录';
      }
    }

    my.showToast({
      type: 'fail',
      content: message,
      duration: 3000
    });
  }

  static wrapAsyncFunction(fn, context = '') {
    return async (...args) => {
      try {
        return await fn.apply(this, args);
      } catch (error) {
        this.handleError(error, context);
        throw error;
      }
    };
  }
}

export default ErrorBoundary;
```

---

## 学习要点总结

### 项目架构设计
- 合理的目录结构和模块划分
- 组件化开发思路
- 数据流管理策略
- 统一的错误处理机制

### 核心功能实现
- 页面布局和交互设计
- 表单处理和验证
- 网络请求和数据管理
- 支付流程集成

### 用户体验优化
- 加载状态的统一管理
- 错误边界的处理
- 页面性能优化
- 离线数据缓存

### 最佳实践
1. **代码规范**: 统一的命名规范和代码风格
2. **错误处理**: 完善的错误捕获和用户提示
3. **性能优化**: 合理的数据加载和缓存策略
4. **用户体验**: 流畅的交互和友好的界面设计

### 扩展建议
- 添加更多便民服务功能
- 集成更多支付宝开放能力
- 优化页面性能和用户体验
- 加强数据安全和隐私保护
